<! DOCTYPE html>
<html lang="it">
<head>
	<meta charset="utf-8">

	<! -- Cytoscape.js -->
	<script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/layout-base/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base/cose-base.js"></script>
    <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>

    <!-- jQuery UI for Autocomplete -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

   	<!-- Louvain for community detection -->
   	<script src="https://cdn.jsdelivr.net/gh/upphiminn/jLouvain@master/src/jLouvain.js"></script>
   	<script src="https://unpkg.com/chroma-js@2.1.0/chroma.min.js"></script>

   	<! -- Stili CSS -->
   	<style>
   		html, body {
   			height: 100%;
   			width: 100%;
   			padding: 0;
   			margin: 0;
   			overflow: hidden;
   			background: #000000;
   			font-family: 'Century Gothic', sans-serif;
   			color: white;
   		}

   		#cy {
   			height: 100%;
   			width: 80%;
   			position: absolute;
   			left: 0;
   			top: 0;
   			background-color: #000000;
   		}

   		#infos {
   			height: 100%;
   			width: 20%;
   			position: absolute;
   			right: 0;
   			top: 0;
   			background-color: #000000;
   			overflow-y: auto;
   			box-shadow: 2px 3px 10px #00000044;
   		}

   		#infos_cont {
   			width: 90%;
   			margin: 15px auto;
   		}

   		#infos_cont table td, #infos_cont table tr {
   			color: white;
   		}

   		#infos_cont td span {
   			margin-left: 10px;
   			display: block;
   		}

   		#search-container {
   			position: absolute;
   			left: 16px;
   			right: 16px;
   			z-index: 3;
   			width: calc(100% - 32px);
   			top: 20px;
   		}

   		#search {
   			padding: 10px 20px;
   			border-radius: 8px;
   			border: 1px solid #bd9554;
   			background-color: #f0f0f0;
   			color: #bd9554;
   			outline: none;
   			width: 20%;
   			font-size: 16px;
   			transition: background-color 0.3s ease, border-color 0.3s ease;
   		}

   		#search:hover {
   			background-color: #e0e0e0;
   		}

   		#search:focus {
   			background-color: #d0d0d0;
   			outline: none;
   			box-shadow: 0 0 5px 2px #bd9554;
   			border-color: #bd9554;
   		}

   		#search::placeholder {
   			font-family: 'Century Gothic', sans-serif;
   			color: #bd9554;
   		}

   		#search::selection {
   			background-color: #bd9554;
   			color: #000000;
   		}

   		#search::-webkit-selection {
   			background-color: #bd9554;
   			color: #000000;
   		}

   		#search::-moz-selection {
   			background-color: #bd9554;
   			color: #000000;
   		}

   		.separator {
   			border-top: 2px solid #bd9554;
   			width: 75%;
   			margin: 20px auto;
   		}

   		#go-to-archive{
   			padding: 10px 20px;
   			border-radius: 8px;
   			border: 1px solid #bd9554;
   			background-color: #bd9554;
   			color: #000000;
   			cursor: pointer;
   			width: 100%;
   			text-align: center;
   			transition: background-color 0.3s ease;
   			font-family: 'Century Gothic', sans-serif;
   		}

   		#go-to-archive:hover {
   			background-color: #e0c85f;
   		}

   		button {
   			background-color: #f0f0f0;
   			color: #000000;
   			border: 1px solid #bd9554;
   			border-radius: 8px;
   			padding: 10px 20px;
   			cursor: pointer;
   			display: block;
   			margin-top: 10px;
   			width: 100%;
   			text-align: center;
   			transition: background-color 0.3s ease;
   			font-family: 'Century Gothic', sans-serif;
   		}

   		button:hover {
   			background-color: #bd9554;
   			border-color: #bd9554;
   		}

   		button:active {
   			background-color: #bd9554;
   			border-color: #bd9554;
   		}

   		.ui-autocomplete {
   			background-color: #f0f0f0;
   			color: #bd9554;
   			border: 1px solid #bd9554;
   			border-radius: 8px;
   			max-height: 200px;
   			overflow-y: auto;
   			padding: 10px;
   			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
   			font-family: 'Century Gothic', sans-serif;
   			z-index: 1000;
   		}

   		.ui_menu-item {
   			padding: 8px 12px;
   			cursor: pointer;
   			background-color: #f0f0f0;
   			border-bottom: 1px solid #bd9554;
   			transition: background-color 0.3s ease;
   		}

   		.ui-menu-item:hover {
   			background-color: #bd9554;
   			color: #000000;
   		}

   		.ui-state-active {
   			background-color: #bd9554;
   			color: #000000;
   		}

   	</style>

</head>
<body>
	
	<div id="cy"></div>

	<div id="infos">
		<div id="infos_cont">
			<table>
				<tr><td style="text-align: right;"><b>Id:</b></td><td><span id="iId"></span></td></tr>
                <tr><td style="text-align: right;"><b>Nome:</b></td><td><span id="iName"></span></td></tr>
			</table>
			<div class="separator"></div>
			<button id="go-to-archive">VEDI I DOCUMENTI</button>
			<div class="separator"></div>
			<button id="highlight-node">Accendi nodo e collegamenti</button>
			<button id="reset-node">Spegni nodo e collegamenti</button>
		</div>
		
	</div>

	<div id="search-container">
		<input type="text" id="search" placeholder="Cerca nel grafo...">		
	</div>

	<script>
	    const nodeIndex = {};

	    fetch('updated-graph-data-final.json')
	    .then(response => response.json())
	    .then(data => {
	        var cy = cytoscape({
	            container: document.getElementById('cy'),
	            elements: data,
	            style: [
	                {
	                    selector: 'node',
	                    style: {
	                        'background-color': 'rgba(128, 0, 128, 0.5)',
	                        'border-width': 2,
	                        'border-color': '#fff',
	                        'opacity': 0.8,
	                        'shape': 'ellipse',
	                        'label': '',
	                        'font-family': 'Century Gothic',
	                        'font-size': '12px',
	                        'color': '#ffffff',
	                        'width': ele => Math.max(10, 5 + ele.degree() * 1.5),
	                        'height': ele => Math.max(10, 5 + ele.degree() * 1.5),
	                        'padding': 0,
	                        'background-opacity': 1,
	                        'border-width': 1,
	                        'text-halign': 'center',
	                        'text-valign': 'center',
	                    }
	                },
	                {
	                    selector: 'edge',
	                    style: {
	                        'width': 0.5,
	                        'line-color': '#ccc',
	                        'opacity': 0.5,
	                        'target-arrow-color': '#ccc',
	                        'target-arrow-shape': 'none'
	                    }
	                }
	            ],
	            layout: {
	                name: 'preset'
	            }
	        });

	        cy.nodes().ungrabify();

	        cy.ready(function() {
	            cy.nodes().forEach(node => {
	                nodeIndex[node.data('name')] = node;
	            });

	            cy.nodes().forEach(function(node) {
	                node.data('nameLower', node.data('name').toLowerCase());
	            });

	            let node_data = cy.nodes().map(n => n.id());
	            let edge_data = cy.edges().map(e => {
	                return {
	                    source: e.source().id(),
	                    target: e.target().id(),
	                    weight: 1.0
	                };
	            });

	            let community = jLouvain()
	                .nodes(node_data)
	                .edges(edge_data); // Corretto: usa edge_data, non node_data

	            let communities = community();

	            var colorPalette = chroma.scale(['purple', 'orange', 'blue', 'green', 'red', 'yellow', 'cyan']).colors(Object.keys(communities).length);

	            cy.style()
	                .selector('node')
	                .style({
	                    'background-color': ele => {
	                        let communityId = communities[ele.id()];
	                        return colorPalette[communityId % colorPalette.length];
	                    }
	                })
	                .update();
	        });

	        function showTooltip(node) {
	            const tooltip = document.createElement('div');
	            tooltip.className = 'tooltip';
	            tooltip.innerHTML = node.data('name');
	            document.body.appendChild(tooltip);

	            const cyContainer = document.getElementById('cy').getBoundingClientRect();
	            const nodePosition = node.renderedPosition();

	            tooltip.style.left = `${cyContainer.left + nodePosition.x + 10}px`; // Correzione delle backtick
	            tooltip.style.top = `${cyContainer.top + nodePosition.y + 10}px`; // Correzione delle backtick

	            node.on('mouseout', function() {
	                tooltip.remove();
	            });
	        }

	        cy.on('mouseover', 'node', function(evt) {
	            const node = evt.target;
	            if (node.degree() <= 25) {
	                showTooltip(node);
	            }
	        });

	        function toggleFixedLabels() {
	            const zoomLevel = cy.zoom();
	            cy.nodes().forEach(node => {
	                if (node.degree() > 50) {
	                    if (zoomLevel >= 0.5) {
	                        node.style({
	                            'label': node.data('name'),
	                            'text-margin-y': 10,
	                            'text-halign': 'center',
	                            'text-valign': 'bottom'
	                        });
	                    } else {
	                        node.style('label', '');
	                    }
	                }
	            });
	        }

	        toggleFixedLabels();

	        cy.on('zoom', function() {
	            toggleFixedLabels();
	        });

	        cy.on('mouseover', 'node', function(evt) {
	            const node = evt.target;
	            if (node.degree() > 25 && node.degree() <= 50) {
	                showTooltip(node);
	            }
	        });

	        const tooltipStyle = document.createElement('style');
	        tooltipStyle.innerHTML = `
	            .tooltip {
	                position: absolute;
	                background: rgba(0, 0, 0, 0.75);
	                color: #fff;
	                padding: 5px;
	                border-radius: 5px;
	                font-size: 12px;
	                pointer-events: none;
	                z-index: 1000;
	                box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5);
	            }
	        `;
	        document.head.appendChild(tooltipStyle);

	        cy.zoomingEnabled(true);
	        cy.minZoom(0.1);
	        cy.maxZoom(3);

	        let selectedNode = null;

	        cy.on('tap', 'node', function(evt) {
	            const node = evt.target;
	            document.getElementById('iId').innerHTML = node.data('id');
	            document.getElementById('iName').innerHTML = node.data('name');
	            selectedNode = node;
	        });

	        document.getElementById('highlight-node').addEventListener('click', function() {
	            if (selectedNode) {
	                cy.batch(() => {
	                    cy.elements().forEach(ele => {
	                        ele.style({
	                            'opacity': 0.2,
	                            'background-color': '#ccc',
	                            'line-color': '#ccc',
	                            'label': ''
	                        });
	                    });

	                    selectedNode.style({
	                        'background-color': '#bd9554',
	                        'opacity': 1,
	                        'label': selectedNode.degree() > 10 ? selectedNode.data('name') : ''
	                    });

	                    selectedNode.connectedEdges().forEach(edge => {
	                        edge.style({
	                            'line-color': '#bd9554',
	                            'opacity': 1
	                        });
	                    });

	                    selectedNode.connectedEdges().connectedNodes().forEach(connectedNode => {
	                        connectedNode.style({
	                            'background-color': '#bd9554',
	                            'opacity': 1,
	                            'label': connectedNode.degree() > 10 ? connectedNode.data('name') : ''
	                        });
	                    });
	                });
	            }
	        });

	        function resetGraphStyle() {
	            cy.elements().removeStyle();
	        }

	        document.getElementById('reset-node').addEventListener('click', function() {
	            resetGraphStyle();
	        });

	        document.getElementById('go-to-archive').addEventListener('click', function() {
	            if (selectedNode) {
	                const archiveUrl = 'https://archiviostorico.mediobanca.com';
	                window.open(archiveUrl, '_blank');
	            }
	        });

	        $("#search").autocomplete({
	            source: function(request, response) {
	                const results = Object.keys(nodeIndex).filter(name => name.toLowerCase().includes(request.term.toLowerCase()));
	                response(results.slice(0, 20));
	            },
	            select: function(event, ui) {
	                const selectedNode = nodeIndex[ui.item.value];

	                cy.batch(() => {
	                    cy.center(selectedNode);
	                    cy.zoom({
	                        level: 2,
	                        position: { x: selectedNode.position('x'), y: selectedNode.position('y') }
	                    });

	                    cy.elements().forEach(ele => {
	                        ele.style({
	                            'opacity': 0.2,
	                            'background-color': '#ccc',
	                            'line-color': '#ccc',
	                            'label': ''
	                        });
	                    });

	                    selectedNode.style({
	                        'background-color': '#bd9554',
	                        'opacity': 1,
	                        'label': selectedNode.degree() > 10 ? selectedNode.data('name') : ''
	                    });

	                    selectedNode.connectedEdges().forEach(edge => {
	                        edge.style({
	                            'line-color': '#bd9554',
	                            'opacity': 1
	                        });
	                    });

	                    selectedNode.connectedEdges().connectedNodes().forEach(connectedNode => {
	                        connectedNode.style({
	                            'background-color': '#bd9554',
	                            'opacity': 1,
	                            'label': connectedNode.degree() > 10 ? connectedNode.data('name') : ''
	                        });
	                    });
	                });

	                $(this).autocomplete('close');
	                $("#search").val('');
	                return false;
	            }
	        });

	    });
	</script>

</body>
</html>